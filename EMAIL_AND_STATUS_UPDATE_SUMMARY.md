# メール通知機能とステータス更新の追加完了 ✅

## 追加された機能

agm_lpac_attendanceに以下の機能を追加しました：

1. **メール通知機能** 📧
   - すべてのユーザーアクションを管理者に通知
   - 複数アドレス対応（カンマ区切り）

2. **出席ステータスの細分化** 👥
   - AGM: 「出席（対面）」「出席（オンライン）」「欠席」
   - LPAC: 「出席（対面）」「出席（オンライン）」「欠席」

## 変更されたファイル

### アプリケーションコア
1. **app.py** (更新)
   - Flask-Mailの設定追加
   - send_notification_email関数追加
   - すべてのルートにメール通知追加
   - 複数通知先対応（NOTIFICATION_EMAILS）
   - 統計情報を対面/オンライン別に集計

2. **requirements.txt** (更新)
   - Flask-Mail>=0.9.1 追加

### テンプレート
3. **templates/user1_dashboard.html** (更新)
   - AGMステータス: 出席（対面）/出席（オンライン）/欠席
   - Flashメッセージ表示

4. **templates/user2_dashboard.html** (更新)
   - AGMステータス: 出席（対面）/出席（オンライン）/欠席
   - LPACステータス: 出席（対面）/出席（オンライン）/欠席
   - Flashメッセージ表示

5. **templates/admin_dashboard.html** (更新)
   - 統計情報に対面/オンライン別の人数表示

6. **templates/import_csv.html** (更新)
   - サンプルフォーマット更新

### CSVテンプレート
7. **participants_template.csv** (更新)
   - ステータスを対面/オンライン対応に更新
   - UTF-8 BOM付き

### ドキュメント
8. **EMAIL_NOTIFICATION_GUIDE.md** (新規)
   - メール通知機能の設定ガイド
   - トラブルシューティング

## メール通知機能の詳細

### 通知されるアクション

1. **ユーザーログイン**
   - ユーザー名、時刻、ロール

2. **ユーザーログアウト**
   - ユーザー名、時刻

3. **参加者追加**
   - ユーザー名、時刻
   - 参加者情報（役職、氏名、メール、AGM/LPACステータス、質問）

4. **参加者情報更新**
   - 変更前と変更後の情報

5. **参加者ステータス更新**
   - ステータス変更の詳細

6. **参加者削除**
   - 削除された参加者情報

7. **参加者CSVインポート**
   - 成功件数、エラー件数、エラー詳細

8. **ユーザーCSVインポート**
   - 成功件数、エラー件数

### 複数通知先の設定

```bash
# 単一アドレス
NOTIFICATION_EMAILS=admin@example.com

# 複数アドレス（カンマ区切り）
NOTIFICATION_EMAILS=admin1@example.com,admin2@example.com,admin3@example.com
```

## 出席ステータスの変更

### Before（変更前）
```
AGM: 出席 / 欠席
LPAC: 出席 / 欠席
```

### After（変更後）
```
AGM: 出席（対面） / 出席（オンライン） / 欠席
LPAC: 出席（対面） / 出席（オンライン） / 欠席
```

### 統計情報の表示

管理者ダッシュボードに以下が表示されます：

```
📈 統計情報
AGM出席者: 15人
  └ 出席（対面）: 10人
  └ 出席（オンライン）: 5人
LPAC出席者: 12人
  └ 出席（対面）: 8人
  └ 出席（オンライン）: 4人
全参加者数: 20人
```

## 環境変数の設定

### 必須の環境変数

```bash
# メールサーバー設定
MAIL_SERVER=smtp.gmail.com
MAIL_PORT=587
MAIL_USE_TLS=True
MAIL_USERNAME=your_email@gmail.com
MAIL_PASSWORD=[Gmailアプリパスワード]

# 通知先メールアドレス（複数可）
NOTIFICATION_EMAILS=admin1@example.com,admin2@example.com
```

### Renderでの設定方法

1. **Gmailアプリパスワード取得**
   - Googleアカウント → セキュリティ → 2段階認証
   - アプリパスワードを生成

2. **環境変数追加**
   - Web Service → Environment タブ
   - 上記の環境変数を追加

3. **デプロイ**
   - 環境変数保存で自動再デプロイ

## テスト方法

### 1. メール通知のテスト

```bash
# 1. ログインテスト
ブラウザでログイン → 通知メールを確認

# 2. 参加者追加テスト
参加者を1件追加 → 通知メールを確認

# 3. ステータス更新テスト
ステータスを変更 → 通知メールを確認
```

### 2. 複数通知先のテスト

```bash
# 環境変数設定
NOTIFICATION_EMAILS=email1@example.com,email2@example.com

# ログイン
# → 両方のアドレスに通知が届くことを確認
```

### 3. ステータス表示のテスト

```bash
# 参加者追加
AGMステータス: 出席（対面）
LPACステータス: 出席（オンライン）

# 管理者ダッシュボードで確認
# → 統計情報が正しく表示されることを確認
```

## CSVテンプレートの更新

### participants_template.csv

```csv
ユーザー名,役職,名前,メール,質問,AGMステータス,LPACステータス
user1,部長,山田太郎,yamada@example.com,特になし,出席（対面）,出席（対面）
user2,課長,佐藤花子,sato@example.com,駐車場について,出席（オンライン）,欠席
user1,係長,鈴木一郎,suzuki@example.com,,欠席,出席（オンライン）
```

## トラブルシューティング

### メールが送信されない

**確認項目:**
1. NOTIFICATION_EMAILSが設定されているか
2. MAIL_USERNAMEとMAIL_PASSWORDが正しいか
3. Gmailアプリパスワードを使用しているか
4. Renderのログでエラーを確認

**ログの確認:**
```
✅ Email sent to 2 recipient(s): ユーザーログイン
⚠️ NOTIFICATION_EMAILS not configured. Email not sent.
❌ Email sending failed: [エラー詳細]
```

### ステータスが正しく表示されない

**解決策:**
1. データベースを更新
2. 既存データのステータスを修正
3. 管理者ダッシュボードで確認

## セキュリティ考慮事項

### メール通知

1. **アプリパスワード使用**
   - 通常のパスワードは使用しない
   - アプリパスワードを定期的に更新

2. **通知先の制限**
   - 社内メールアドレスのみ
   - 必要最小限のアドレス

3. **TLS暗号化**
   - MAIL_USE_TLS=True を必ず設定

### 個人情報保護

1. メール内容に配慮
   - 氏名、メールアドレスなど個人情報を含む
   - 通信は暗号化

2. 通知先の管理
   - 権限のある管理者のみ
   - 定期的に確認

## 利点

### メール通知機能

✅ **リアルタイム監視**
- すべてのアクションを即座に把握
- 不正アクセスの早期発見

✅ **監査ログ**
- メールが記録として残る
- 誰が何をしたか追跡可能

✅ **複数管理者対応**
- 複数の管理者に同時通知
- チームでの管理が容易

✅ **アクションの透明性**
- すべての変更が記録される
- 説明責任の向上

### ステータスの細分化

✅ **正確な統計**
- 対面参加者数を把握
- オンライン参加者数を把握
- 会議室や設備の準備が正確に

✅ **柔軟な参加形態**
- ハイブリッド会議に対応
- 参加者の選択肢が増える

✅ **レポート作成**
- 詳細な出席レポート
- 参加形態の分析が可能

## データ移行

既存のデータがある場合：

### 方法1: CSVエクスポート・インポート

```bash
# 1. 既存データをエクスポート
管理者ダッシュボード → CSV出力

# 2. Excelで編集
「出席」→「出席（対面）」または「出席（オンライン）」に変更

# 3. 再インポート
管理者ダッシュボード → CSVインポート
```

### 方法2: データベース直接更新

```sql
-- 全ての「出席」を「出席（対面）」に変更
UPDATE participant SET agm_status = '出席（対面）' WHERE agm_status = '出席';
UPDATE participant SET lpac_status = '出席（対面）' WHERE lpac_status = '出席';
```

## まとめ

今回の機能追加により：

1. **メール通知**
   - すべてのアクションをリアルタイム監視
   - 複数管理者に同時通知
   - 監査ログとして活用

2. **ステータス細分化**
   - 対面/オンライン参加を区別
   - 正確な統計情報
   - ハイブリッド会議に対応

agm_lpac_attendanceの管理機能が大幅に強化されました！

## 次のステップ

### 1. Renderで環境変数を設定

```
MAIL_SERVER = smtp.gmail.com
MAIL_PORT = 587
MAIL_USE_TLS = True
MAIL_USERNAME = your_email@gmail.com
MAIL_PASSWORD = [アプリパスワード]
NOTIFICATION_EMAILS = admin1@example.com,admin2@example.com
```

### 2. デプロイ

環境変数を保存すると自動的に再デプロイされます

### 3. テスト

1. ログインして通知メールを確認
2. 参加者を追加して通知を確認
3. 統計情報を確認

### 4. 既存データの移行（必要な場合）

CSVエクスポート → 編集 → 再インポート

---

**機能追加日**: 2025年11月25日
**バージョン**: v1.2 - Email Notifications & Status Enhancement
**ステータス**: ✅ Production Ready
